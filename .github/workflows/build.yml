name: Build OXCY APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04  # Explicitly using 22.04 for better stability
    steps:
      - uses: actions/checkout@v4

      # 1. Setup Java 17 (Required for Android)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. Setup Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. The "Nuclear" Install (Fixes your 'autoconf' & 'Broken pipe' errors)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          # This massive list installs EVERYTHING Buildozer might need
          sudo apt-get install -y \
            build-essential libtool libtool-bin autoconf automake \
            pkg-config libffi-dev libssl-dev python3-dev \
            git zip unzip libltdl-dev zlib1g-dev \
            libncurses5-dev libgdbm-dev libnss3-dev \
            libreadline-dev wget
          
          # Install Buildozer
          pip install --user --upgrade buildozer cython==0.29.33 virtualenv

          # Add user bin to PATH so we can run buildozer
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 4. The Build (With 'yes' to accept licenses)
      - name: Build OXCY APK
        env:
          JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
        run: |
          # The 'yes' command forces acceptance of the SDK license
          yes | buildozer android debug

      # 5. Upload the Result
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OXCY-App
          path: bin/*.apk
